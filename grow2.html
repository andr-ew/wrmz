<!DOCTYPE html>
<html>
    <head>
        <link href="/style.css" rel="stylesheet" />
    </head>
    <body>
        <button id="record" type="button" onclick="record()">record</button>
        <script src="https://unpkg.com/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
        <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
        <script type="module">
            import * as THREE from 'https://unpkg.com/three@0.137.5?module';
            import { OrbitControls } from 'https://unpkg.com/three@0.137.5/examples/jsm/controls/OrbitControls.js?module';
            import { loop } from './js/setup.js';
            import {
                Wrm,
                Coaster,
                loadmodel,
                makemodel,
                makecrv,
                sky,
                getTVFrames,
                TV,
                SignPostPlacer,
                BillboardPlacer,
                JumboSphere,
                ObjectInViewportChecker,
                wrap_minmax,
            } from './js/wrms.js';
            import { Curves } from 'https://unpkg.com/three@0.137.5/examples/jsm/curves/CurveExtras.js?module';

            window.THREE = THREE;

            const duration = 60 * 4 + 13;
            //const duration = 5;

            new THREE.TextureLoader().load(
                //'img/IMG_0331.jpeg',
                //'img/IMG_1922.JPG',
                'img/IMG_1922 2.JPG',
                tex => {
                    loop(duration, (scene, camera, renderer) => {
                        scene.background = sky(renderer, tex);

                        var orbit = new OrbitControls(
                            camera,
                            renderer.domElement
                        );

                        let crv = new THREE.TubeBufferGeometry(
                            new Curves.DecoratedTorusKnot5c(900),
                            2600,
                            1,
                            3,
                            true
                        );

                        var wrm = new Wrm(
                            'flower',
                            crv,
                            1000,
                            t => ({ x: (-Math.PI / 2) * 1, z: 0 * -Math.PI }),
                            null,
                            wrm => {
                                wrm.update(0);
                            }
                        );
                        scene.add(wrm.group);

                        camera.position.z = 1600;

                        //TODO: consider adding some wrms (???)

                        const checker = new ObjectInViewportChecker(camera);

                        /*
                        const signposts = new SignPostPlacer(
                            50,
                            crv,
                            () => new TV(100)
                        );
                        scene.add(signposts.group);

                        const billboards = new BillboardPlacer(
                            25,
                            crv,
                            () =>
                                new TV(
                                    150,
                                    duration *
                                        (Math.random() / 2 + 1 / 4) *
                                        1000,
                                    checker
                                )
                        );
                        scene.add(billboards.group);

                        var jumbsphere = new JumboSphere(
                            42 * (1 / 2),
                            () =>
                                new TV(
                                    500,
                                    Math.random() > 0.5
                                        ? duration *
                                          (Math.random() / 2 + 1 / 4) *
                                          1000
                                        : duration * (1 / 8) * 1000,
                                    checker
                                )
                        );
                        scene.add(jumbsphere.group);
                        //*/

                        /*
                        getTVFrames('ls_vid.json', frames => {
                            const ids = Object.keys(frames);
                            tvPosts.forEach((tvPost, i) => {
                                const id = ids[i % ids.length];
                                tvPost.frames = frames[id];
                            });

                            const ids2 = Object.keys(frames).reverse();
                            tvBillboards.forEach((tv, i) => {
                                const id = ids2[i % ids2.length];
                                tv.frames = frames[id];
                            });

                            jumbsphere.tvs.forEach((tv, i) => {
                                const id = ids[i % ids.length];
                                tv.frames = frames[id];
                            });
                        });
                        //*/

                        //TODO: intro

                        let coaster = new Coaster(camera, crv, 60, false);
                        coaster.offset = 60 * 3;
                        coaster.rotation = (0 / 2) * Math.PI;

                        const introDuration = 10;
                        const rotationDuration = 70;
                        const accelDuration = 30;

                        const coasterData = {
                            offset: coaster.offset,
                            rotation: coaster.rotation,
                            velocity: 0.000006,
                            position: 1 + 0.155,
                        };

                        const tweenGroup = new TWEEN.Group();

                        const rotationTween = new TWEEN.Tween(
                            coasterData,
                            tweenGroup
                        )
                            .to(
                                {
                                    rotation: -Math.PI,
                                },
                                rotationDuration * 1000
                            )
                            .easing(TWEEN.Easing.Quadratic.InOut)
                            .delay(introDuration * 1000 * 1);

                        const offsetTween = new TWEEN.Tween(
                            coasterData,
                            tweenGroup
                        )
                            .to(
                                {
                                    offset: 70,
                                },
                                rotationDuration * 1000
                            )
                            .easing(TWEEN.Easing.Quadratic.InOut)
                            .delay(introDuration * 1000 * 0.5);

                        const accelTween = new TWEEN.Tween(
                            coasterData,
                            tweenGroup
                        )
                            .to(
                                {
                                    velocity: 0.000016,
                                },
                                accelDuration * 1000
                            )
                            .easing(TWEEN.Easing.Linear.None)
                            .delay(0);

                        return (t, elapsed, first) => {
                            if (first) {
                                rotationTween.start(0);
                                offsetTween.start(0);
                                accelTween.start(0);
                            }
                            tweenGroup.update(elapsed, false);

                            coaster.update(wrap_minmax(coasterData.position));
                            coasterData.position += coasterData.velocity;

                            coaster.offset = coasterData.offset;
                            coaster.rotation = coasterData.rotation;

                            /*

                            signposts.update(t, elapsed);
                            billboards.update(t, elapsed);
                            jumbsphere.tvs.forEach(tv => tv.update(elapsed));
                            //*/
                        };
                    });
                }
            );
        </script>
    </body>
</html>
